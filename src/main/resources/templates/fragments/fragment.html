<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:fragment="head">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.104.2">
    <title>Album example · Bootstrap v5.2</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">


    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        .card-body {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

    </style>


</head>
<body>
<!-- 네비바-->
<header class="p-3 text-bg-dark" th:fragment="nav">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap">
                    <use xlink:href="#bootstrap"/>
                </svg>
            </a>
            <!-- 메뉴-->
            <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                <li><a href="#" class="nav-link px-2 text-white"><h4>💪운동메&emsp;&emsp;</h4></a></li>
                <li><a href="/view/v1/crews/" class="nav-link px-2 text-white"><h5>모집글&emsp;&emsp;</h5></a></li>
                <li><a href="/view/v1/alarm/" sec:authorize="isAuthenticated()" th:href="@{/view/v1/alarm}" class="nav-link px-2 text-white"><h5>알림&emsp;&emsp;</h5>
                </a></li>
                <li><a href="/view/v1/users/profile/my" th:href="@{/view/v1/users/profile/my}"
                       class="nav-link px-2 text-white"><h5>My프로필&emsp;&emsp;</h5></a></li>

                <li><a href="/view/v1/rooms" class="nav-link px-2 text-white">CHAT!</a></li>
            </ul>

            <!-- 검색-->
            <form class="col-3 col-lg-3 mb-4 mb-lg-0 me-lg-3" role="search" action="/view/v1/crews/strict" method="post"
                  name="findAllCrewWithStrict">
                <input type="search" name="strict" class="form-control form-control-dark text-bg-dark"
                       placeholder="관심 있는 지역을 검색해 보세요" aria-label="Search">
            </form>

            <!-- 로그인&회원가입-->
            <div class="text-end">
                <button type="button" class="btn btn-outline-light me-2" sec:authorize="!isAuthenticated()"
                        onclick="location.href='/view/v1/start'">Login
                </button>
                <button type="button" class="btn btn-warning" sec:authorize="!isAuthenticated()"
                        onclick="location.href='/view/v1/start'">Sign-up
                </button>
                <span class="text-white" sec:authorize="isAuthenticated()" sec:authentication="name" id="myName">사용자</span>
                <span class="text-white" sec:authorize="isAuthenticated()" >님 환영합니다✨</span>
                <a type="button" class="btn btn-warning" th:href="@{/view/v1/logout}" sec:authorize="isAuthenticated()">Logout</a>
            </div>


        </div>
    </div>
</header>

<footer class="py-3 my-4" th:fragment="footer">
    <ul class="nav justify-content-center border-bottom pb-3 mb-3">
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Home</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Features</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Pricing</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">FAQs</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">About</a></li>
    </ul>
    <p class="text-center text-muted">© 2023 Company, Inc</p>
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
</footer>


</body>


<script type="application/javascript" th:fragment="form-validation">
    (function () {
        'use strict';

        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            let forms = document.getElementsByClassName('needs-validation');

            // Loop over them and prevent submission
            Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        }, false)
    }())
</script>

<script type="application/javascript" th:inline="javascript" th:fragment="read-crew">
    const crewId = [[${crewId}]];
    const username = [[${#authentication.name}]];

    $(function() {
        getComment();
    });

    function confirmDelete() {
        if(confirm("정말 삭제하시겠습니까?")) {
            $("#form").submit();
        }
        return false;
    }

    function replyPut() { // 대댓글 수정
        if (confirm("수정하시겠습니까?")) {
            const commentId= $('#id').val();
            const crewId= $('#crewId').val();
            const content= $('#rcontent').val();
            $.ajax({
                type: "PUT",
                url: "/view/v1/crews/"+crewId+"/comments/"+commentId,
                data: JSON.stringify({"crewCommentId": crewId, "comment": content, "id": commentId}),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if(data == "articleCommentUpdating Success"){
                        alert('댓글이 수정되었습니다.');
                        location.reload();
                    }
                },
                error: function (status) {
                    status.responseJSON.forEach(function () {
                        $('.'+id+'ucommentContentCheck').text(this.message);
                        $('.'+id+'ucommentContentCheck').css('display', 'block');
                    } )
                }
            });
        }
    }

    function replyDelete(id) { // parentId
        if (confirm("삭제하시겠습니까?")) {
            const crewId= $('#crewIdComment').val();
            $.ajax({
                type: "DELETE",
                url: "/view/v1/crews/"+crewId+"/comments/"+id,
                data: JSON.stringify({"crewId": crewId, "id": id}),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if(data == "articleCommentDeleting Success"){
                        alert('댓글이 삭제되었습니다.');
                        getComment();
                    }
                },
                error: function (request, status, error) {
                    alert(request.responseText);
                }
            })}}



    function commentUpdate (id) {
        if (confirm("수정하시겠습니까?")) {
            const crewId = $('#crewIdComment').val();
            const ucommentContent = $('#'+id+'ucommentContent').val();
            $.ajax({
                type: "PUT",
                url: "/view/v1/crews/"+ crewId +"/comments/"+id,
                data: JSON.stringify({"crewId": crewId,
                    "comment": ucommentContent,
                }),
                contentType: "application/json; charset=utf-8",
                success: function(data) {
                    alert(data) ;
                    getComment();
                    $('.'+id+'ucommentContentCheck').text('');
                    $('.'+id+'ucommentContentCheck').css('display', 'none');
                },
                error: function (status) {
                    $(status.responseJSON).each(function(){
                        $('.'+id+'ucommentContentCheck').text(this.message);
                        $('.'+id+'ucommentContentCheck').css('display', 'block');
                    })
                }
            });
        }
    }

    $("#replyContent").blur(function(){
        const content = $("#replyContent").val();
        if(content.length > 100 || content.length<2){
            $(".replyContentCheck").text("댓글을 2자 이상 100자 이하로 입력해주세요.");
            $(".replyContentCheck").css("color", "red");
        }else {
            $(".replyContentCheck").text("");
            $(".replyContentCheck").css("color", "green");
        }
    });
    $("#ucommentContent").blur(function(){
        const content = $("#ucommentContent").val();
        if(content.length > 100 || content.length<2){
            $(".ucommentContentCheck").text("댓글을 2자 이상 100자 이하로 입력해주세요.");
            $(".ucommentContentCheck").css("color", "red");
        }else {
            $(".ucommentContentCheck").text("");
            $(".ucommentContentCheck").css("color", "green");
        }
    });
    // 부모댓글 리스트 출력
    function getComment(){

        const principal = $("#principal").val(); // username
        $("#commentList").empty();  // 댓글 리스트가 비어있는지 확인
        const crewId = document.getElementById("crewIdComment").value;
        $.ajax({
            type:"get",
            url:"/view/v1/crews/"+ crewId +"/comments",
            dataType:"json",
            success:function (data) {
                console.log(data);
                var html = " ";
                $(data).each(function(){ // comment
                    if(this.parent===true && this.deleted ===false){
                        html += "<ul class='list-group'>";
                        html += "<li class='list-group-item comments'>";
                        html += "<div class='comment' id='"+this.id+"comment'>";
                        html += "<a href='javascript:; class='userImg'>";
                        html += "<img src='https://user-images.githubusercontent.com/109712249/214782553-abb78e43-e1d8-4b35-bd7f-5127e852f398.png'  width='35px' height='35px' alt='userImg' class='userImg'>";
                        html += "</a>";
                        html += "<a href='javascript:;' class='writer' style='display:inline'>" + this.userName + "</a>";
                        html += "<div class='comment-info'>";
                        html += "<span class='comment4 date'>" + getFormatDate(new Date(this.createdAt)) + "</span>";
                        html += "<div class='comment-text' id='"+this.id+"content'> " + this.comment + "</div>";
                        html += "<div class='comment_etc'>";
                        html += "<div class='comment-info'>";
                        html += "<a href='javascript:;' class='btn btn-secondary btn-icon-split comment_delete' id='"+this.id+"getChildrenBtn' >";
                        html += "<button id='"+this.id+"getChildrenBtn' onclick='getChildrenComment("+this.id+")' class='btn btn'>답글("+this.children.length+")</button>";
                        html += "</a>";
                        if(principal === this.userName) {
                            html += "<a href='javascript:;'>";
                            html += "<button type='button' onclick='commentDelete(" + this.id + ")' class='delete btn btn-outline-danger'  id='" + this.id + "deleteBtn'>삭제";
                            html += "</button>";
                            html += "</a>";
                        }if(principal === this.userName) {
                            html += "<a href='javascript:;'>";
                            html += "<button type='button'  onclick='commentUpdateForm(" + this.id + ")' class='btn btn-outline-secondary'  id='" + this.id + "updateBtn'>수정";
                            html += "</button>";
                            html += "</a>";
                        }
                        html += "</div>";
                        html += "</div>";
                        html += "</div>";
                        html += "</li>";
                        html += "<div id='"+this.id+"children' class='children'></div>";
                    }

                });
                html += "</ul>";

                $("#commentList").append(html);

            }
        });
    }
    function getFormatDate(date){
        var year = date.getFullYear();              //yyyy
        var month = (1 + date.getMonth());          //M
        month = month >= 10 ? month : '0' + month;  //month 두자리로 저장
        var day = date.getDate();                   //d
        day = day >= 10 ? day : '0' + day;          //day 두자리로 저장
        var hour = date.getHours();
        hour = hour >= 10 ? hour : '0' + hour;
        var minute = date.getMinutes();
        minute = minute >= 10 ? minute : '0' + minute;
        var second = date.getSeconds();
        second = second >= 10 ? second : '0' + second;

        return  year + '-' + month + '-' + day +' '+ hour +':'+ minute+':'+second//'-' 추가하여 yyyy-mm-dd 형태 생성 가능
    }


    function commentDelete (id) {
        if (confirm("삭제하시겠습니까?")) {
            $.ajax({
                type: "DELETE",
                url: "/view/v1/crews/"+crewId+"/comments/"+ id,
                contentType: "application/json; charset=utf-8",
                success: function () {
                    alert('댓글이 삭제되었습니다.');
                    getComment();
                }
                ,
                error: function (xhr, status, error) {
                    alert(status.message);
                }
            });
        }
    }

    function commentUpdateForm(id){
        $("#"+id+"updateBtn").hide();
        $.ajax({
            type: "GET",
            url: "/view/v1/crews/"+crewId+"/comments/"+id,
            dataType: "json",
            success: function (data) {
                var html = "<div class='comment-update'>";
                html += "<div class='comment-update-form'>";
                html += "<textarea class='form-control' id='"+id+"ucommentContent' rows='3' placeholder='댓글을 입력하세요.'>"+data.comment+"</textarea>";
                html += "<div class='field-error "+id+"ucommentContentCheck'>";
                html += "</div>";
                html += "<div class='comment-update-btn'>";
                html += "<button type='button' class='btn btn-secondary'  onclick='commentUpdate("+data.id+")'>수정</button>";
                html += "<button type='button' class='btn btn-secondary' onclick='commentUpdateCancel("+data.id+")'>취소</button>";
                html += "</div>";
                html += "</div>";
                html += "</div>";
                $("#"+data.id+"content").html(html);
            },
            error: function (xhr, status, error) {
                alert(status.message);
            }
        });
    }
    function commentUpdateCancel(id){
        $(".comment-update").html("");
        $("#"+id+"updateBtn").show();
        getComment();
    }

    function getChildrenComment(parentId){ //commentId(parent)
        const crewId = document.getElementById("crewIdComment").value;
        $("#"+parentId+"children").empty();
        $("#"+parentId+"children").show();
        const principal = $("#principal").val(); //userName
        $.ajax({
            type: "GET",
            url: "/view/v1/crews/"+crewId+"/comments/"+parentId+"/list",

            dataType: "json",
            success: function (data) { // children
                console.log(data);
                console.log("crewId:", crewId)
                console.log("parentId:",parentId)
                let html = "<ul class='list-group'>";
                if(principal!=null){
                    console.log("principle의 값:",principal);
                    html +="<form>";
                    html += "<input type='text' class='form-control' id='"+parentId+"replyContent' placeholder='답글을 입력하세요.'>";
                    html += "<div class='field-error rcommentContentCheck'>";
                    html += "</div>";
                    html += "<input type='hidden' id='crewId' value='"+data.crewId+"'>";
                    html += "<button type='button' class='btn btn-primary' onclick='replyCheck("+parentId+")'>답글등록</button>";
                    html += "<div class='field-error "+data.id+"replyContentCheck'>";
                    html += "</div>";
                    html += "</form>";}
                $(data).each(function () {
                    if(this.deleted === false) {
                        console.log("success시 받는 data:"+this.id)
                        html += "<li class='list-group-item comments' style=\"background-color:#D9DCEB;\">";
                        html += "<div class='childrenComment' id='" + this.id + "comment'>";
                        html += "<a href='javascript:; class='comment-img'>";
                        html += "<img src='https://user-images.githubusercontent.com/109712249/214782553-abb78e43-e1d8-4b35-bd7f-5127e852f398.png'  width='35px' height='35px' alt='userImg' class='userImg'>";
                        html += "</a>";
                        html += "<div class='comment-info'>";
                        html += "<span class='comment4 date'>" + getFormatDate(new Date(this.createdAt)) + "</span>";
                        html += "<a href='javascript:;' class='writer' style='display:inline'>" + this.userName + "</a>";
                        html += "<div class='comment-text' id='" + this.id + "content'> " + this.comment + "</div>";
                        html += "<div class='comment_etc'>";
                        html += "<div class='comment-info'>";
                        if(principal === this.userName) {
                            html += "<a href='javascript:;'>";
                            html += "<button type='button' onclick='replyDelete(" + this.id + ")' class='delete btn btn-outline-danger'  id='" + this.id + "deleteBtn'>삭제";
                            html += "</button>";
                            html += "</a>";
                        }
                        if(principal === this.userName) {
                            html += "<a href='javascript:;'>";
                            html += "<button type='button'  onclick='commentUpdateForm(" + this.id + ")' class='btn btn-outline-secondary'  id='" + this.id + "updateBtn'>수정";
                            html += "</button>";
                        }
                        html += "</div>";
                        html += "</div>";
                        html += "</div>";
                        html += "</li>";
                    }});
                html += "</ul>";
                $("#"+parentId+"children").append(html);
                $("#"+parentId+"children").show();
                $("#"+parentId+"getChildrenBtn").html("접기");
                $("#"+parentId+"getChildrenBtn").attr("onclick","getChildrenCommentHide("+parentId+")");
            },
            error: function (xhr, status, error) {
                alert(status);
            }
        });

    }
    function getChildrenCommentHide(id){ // 댓글의 detail 가져오기
        $("#"+id+"children").html("");
        $("#"+id+"children").hide();
        $.ajax({
            type: "GET",
            url: "/view/v1/crews/"+crewId+"/comments/"+id,
            dataType: "json",
            success: function (data) {
                $("#"+id+"getChildrenBtn").html("답글("+data.children.length+")");
                $("#"+id+"getChildrenBtn").attr("onclick","getChildrenComment("+data.id+")");
            },
            error: function (xhr, status, error) {
                alert(status);
            }
        });

    }




    // 버튼 클릭 시 첫번째 실행 -> 부모 댓글 작성
    function commentCheck() {
        const content = $("#commentContent").val();
        const crewId = $("#crewIdComment").val();
        $.ajax({
            type : "POST",
            url: '/view/v1/crews/'+ crewId +'/comments',
            async: false,
            data: JSON.stringify({
                "comment": content,
                "crewId": crewId,
                "parentId" : null
            }),
            contentType : "application/json; charset=utf-8",
            success: function(data) {
                alert("등록 되었습니다.") ;
                getComment();
                $('.commentContentCheck').text('');
                $('.commentContentCheck').css('display', 'none');
            },
            error: function (status) {
                alert("로그인 후 작성이 가능합니다.");
                $(status.responseJSON).each(function(){
                    $('.commentContentCheck').text(this.message);
                    $('.commentContentCheck').css('display', 'block');
                })
            }
        })
    }


    function replyCheck(parentId) { // 대댓글 작성
        var replyContent = $("#"+parentId+"replyContent").val();
        var crewId = $("#crewIdComment").val();
        $.ajax({
            type : "POST",
            url: '/view/v1/crews/'+ crewId +'/comments/'+parentId,
            data: JSON.stringify({
                "comment": replyContent,
                "parentId" : parentId
            }),
            contentType : "application/json; charset=utf-8",
            success: function(data) {
                alert(data);
                getChildrenComment((parentId))
            },
            error: function (status) {
                $(status.responseJSON).each(function(){
                    alert("로그인 후 작성이 가능합니다.") ;
                    $('.'+parentId+'replyContentCheck').text(this.message);
                    $('.'+parentId+'replyContentCheck').css('display', 'block');
                })

            }
        }) ;
    }


    function likeBtn(crewId){
        $.ajax({
            type : "POST",
            url: '/view/v1/crews/'+crewId+'/like',
            success: function(data) {
                console.log(data);
                if(data.likeCheck == 1){
                    alert("좋아요를 누르시겠습니까?")
                    $("#likeCnt").empty();
                    $("#likeCnt").append(data.count);
                }
                else if (data.likeCheck == 0){
                    alert("좋아요를 취소하시겠습니까?")
                    $("#likeCnt").empty();
                    $("#likeCnt").append(data.count);

                }
            },
            error: function (request, status, error) {
                alert("로그인 후 좋아요가 가능합니다.")
                // alert(request.responseText);
            }
        }) ;
    }
</script>
